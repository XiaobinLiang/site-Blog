<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,熊猫小A,Galileo,blog" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Prism" />
    <link rel="alternate" type="application/rss+xml" title="无文字 | 三无计划 &raquo; RSS 2.0" href="/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="无文字 | 三无计划 &raquo; ATOM 1.0" href="/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/prism-561767ec37.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/ExSearch/ExSearch-182e5a8869.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/993aa3dcb70943b3e506b13b3d502541.json"
        }

    </script>
    
<title>无文字 | 三无计划</title>
<meta name="author" content="熊猫小A" />
<meta name="description" content="只坚持一种正义。我的正义。" />
<meta property="og:title" content="无文字 | 三无计划" />
<meta property="og:description" content="只坚持一种正义。我的正义。" />
<meta property="og:site_name" content="无文字 | 三无计划" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/page/3/" />
<meta property="og:image" content="无文字 | 三无计划" />
<meta name="twitter:title" content="无文字 | 三无计划" />
<meta name="twitter:description" content="只坚持一种正义。我的正义。" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/android-chrome-512x512.png" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
<link rel="dns-prefetch" href="//blog.imalan.cn" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/brand_font/embed.css" />
<style>.brand{font-family:FZCuJinLFW,serif;font-weight: normal!important;}</style>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/apple-touch-icon.png?v=PY43YeeEKx">
<link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/favicon-32x32.png?v=yyLyaqbyRG">
<link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/favicon-16x16.png?v=yyLyaqbyRG">
<link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/safari-pinned-tab.svg?v=yyLyaqbyRG" color="#505050">
<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/favicon.ico?v=yyLyaqbyRG">
<meta name="application-name" content="三無計劃">
<meta name="apple-mobile-web-app-title" content="三無計劃">
<meta name="msapplication-TileColor" content="#000000">
<meta name="theme-color" content="#000000">
<meta name="baidu-site-verification" content="9BEwwo6Ibg" />

</head>

<body>
    <div class="container prism-container">
        <header class="prism-header" id="prism__header">
            <h1 class="text-uppercase"><a class="no-link" href="/" target="_self">无文字 | 三无计划</a></h1>
            <p>只坚持一种正义。我的正义。</p>
            <nav class="prism-nav"><ul><li><a class="no-link text-uppercase " href="/" target="_self">首页</a></li><li><a class="no-link text-uppercase " href="/archives/" target="_self">归档</a></li><li><a class="no-link text-uppercase " href="/links/" target="_self">友链</a></li><li><a class="no-link text-uppercase " href="/about/" target="_self">关于</a></li><li><a href="#" target="_self" class="search-form-input no-link text-uppercase">搜索</a></li></ul></nav>
        </header>
        <div class="prism-wrapper" id="prism__wrapper">
            
<main>    
    

<section id="prism__post-list" class="prism-section row">
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/321/" target="_self">狂人日记</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/321/" target="_self">
                <time class="text-uppercase">
                    May 05 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>某君昆仲，今隐其名，皆余昔日在中学时良友；分隔多年，消息渐阙。日前偶闻其一大病；适归故乡，迂道往访，则仅晤一人，言病者其弟也。劳君远道来视，然已早愈，赴某地候补矣。因大笑，出示日记二册，谓可见当日病状，不妨献诸旧友。持归阅一过，知所患盖“迫害狂”之类。语颇错杂无伦次，又多荒唐之言；亦不著月日，惟墨色字体不一，知非一时所书。间亦有略具联络者，今撮录一篇，以供医家研究。记中语误，一字不易；惟人名虽皆村人，不为世间所知，无关大体，然亦悉易去。至于书名，则本人愈后所题，不复改也。</p>
<center><h3>一</h3></center><p>今天晚上，很好的月光。</p>
<p>我不见他，已是三十多年；今天见了，精神分外爽快。才知道以前的三十多年，全是发昏；然而须十分小心。不然，那赵家的狗，何以看我两眼呢？</p>
<p>我怕得有理。</p>
<center><h3>二</h3></center><p>今天全没月光，我知道不妙。早上小心出门，赵贵翁的眼色便怪：似乎怕我，似乎想害我。还有七八个人，交头接耳的议论我，张着嘴，对我笑了一笑；我便从头直冷到脚根，晓得他们布置，都已妥当了。</p>
<p>我可不怕，仍旧走我的路。前面一伙小孩子，也在那里议论我；眼色也同赵贵翁一样，脸色也铁青。我想我同小孩子有什么仇，他也这样。忍不住大声说，“你告诉我！”他们可就跑了。</p>
<p>我想：我同赵贵翁有什么仇，同路上的人又有什么仇；只有廿年以前，把古久先生的陈年流水簿子，踹了一脚，古久先生很不高兴。赵贵翁虽然不认识他，一定也听到风声，代抱不平；约定路上的人，同我作冤对。但是小孩子呢？那时候，他们还没有出世，何以今天也睁着怪眼睛，似乎怕我，似乎想害我。这真教我怕，教我纳罕而且伤心。</p>
<p>我明白了。这是他们娘老子教的！</p>
<center><h3>三</h3></center><p>晚上总是睡不着。凡事须得研究，才会明白。</p>
<p>他们——也有给知县打枷过的，也有给绅士掌过嘴的，也有衙役占了他妻子的，也有老子娘被债主逼死的；他们那时候的脸色，全没有昨天这么怕，也没有这么凶。</p>
<p>最奇怪的是昨天街上的那个女人，打他儿子，嘴里说道，“老子呀！我要咬你几口才出气！”他眼睛却看着我。我出了一惊，遮掩不住；那青面獠牙的一伙人，便都哄笑起来。陈老五赶上前，硬把我拖回家中了。</p>
<p>拖我回家，家里的人都装作不认识我；他们的脸色，也全同别人一样。进了书房，便反扣上门，宛然是关了一只鸡鸭。这一件事，越教我猜不出底细。</p>
<p>前几天，狼子村的佃户来告荒，对我大哥说，他们村里的一个大恶人，给大家打死了；几个人便挖出他的心肝来，用油煎炒了吃，可以壮壮胆子。我插了一句嘴，佃户和大哥便都看我几眼。今天才晓得他们的眼光，全同外面的那伙人一模一样。</p>
<p>想起来，我从顶上直冷到脚跟。</p>
<p>他们会吃人，就未必不会吃我。</p>
<p>你看那女人“咬你几口”的话，和一伙青面獠牙人的笑，和前天佃户的话，明明是暗号。我看出他话中全是毒，笑中全是刀。他们的牙齿，全是白厉厉的排着，这就是吃人的家伙。</p>
<p>照我自己想，虽然不是恶人，自从踹了古家的簿子，可就难说了。他们似乎别有心思，我全猜不出。况且他们一翻脸，便说人是恶人。我还记得大哥教我做论，无论怎样好人，翻他几句，他便打上几个圈；原谅坏人几句，他便说“翻天妙手，与众不同”。我那里猜得到他们的心思，究竟怎样；况且是要吃的时候。</p>
<p>凡事总须研究，才会明白。古来时常吃人，我也还记得，可是不甚清楚。我翻开历史一查，这历史没有年代，歪歪斜斜的每页上都写着“仁义道德”几个字。我横竖睡不着，仔细看了半夜，才从字缝里看出字来，满本都写着两个字是“吃人”！</p>
<p>书上写着这许多字，佃户说了这许多话，却都笑吟吟的睁着怪眼看我。</p>
<p>我也是人，他们想要吃我了！</p>
<center><h3>四</h3></center><p>早上，我静坐了一会儿。陈老五送进饭来，一碗菜，一碗蒸鱼；这鱼的眼睛，白而且硬，张着嘴，同那一伙想吃人的人一样。吃了几筷，滑溜溜的不知是鱼是人，便把他兜肚连肠的吐出。</p>
<p>我说“老五，对大哥说，我闷得慌，想到园里走走。”老五不答应，走了；停一会，可就来开了门。</p>
<p>我也不动，研究他们如何摆布我；知道他们一定不肯放松。果然！我大哥引了一个老头子，慢慢走来；他满眼凶光，怕我看出，只是低头向着地，从眼镜横边暗暗看我。大哥说，“今天你仿佛很好。”我说“是的。”大哥说，“今天请何先生来，给你诊一诊。”我说“可以！”其实我岂不知道这老头子是刽子手扮的！无非借了看脉这名目，揣一揣肥瘠：因这功劳，也分一片肉吃。我也不怕；虽然不吃人，胆子却比他们还壮。伸出两个拳头，看他如何下手。老头子坐着，闭了眼睛，摸了好一会，呆了好一会；便张开他鬼眼睛说，“不要乱想。静静的养几天，就好了。”</p>
<p>不要乱想，静静的养！养肥了，他们是自然可以多吃；我有什么好处，怎么会“好了”？他们这群人，又想吃人，又是鬼鬼祟祟，想法子遮掩，不敢直截下手，真要令我笑死。我忍不住，便放声大笑起来，十分快活。自己晓得这笑声里面，有的是义勇和正气。老头子和大哥，都失了色，被我这勇气正气镇压住了。</p>
<p>但是我有勇气，他们便越想吃我，沾光一点这勇气。老头子跨出门，走不多远，便低声对大哥说道，“赶紧吃罢！”大哥点点头。原来也有你！这一件大发见，虽似意外，也在意中：合伙吃我的人，便是我的哥哥！</p>
<p>吃人的是我哥哥！</p>
<p>我是吃人的人的兄弟！</p>
<p>我自己被人吃了，可仍然是吃人的人的兄弟！</p>
<center><h3>五</h3></center><p>这几天是退一步想：假使那老头子不是刽子手扮的，真是医生，也仍然是吃人的人。他们的祖师李时珍做的“本草什么”上，明明写着人肉可以煎吃；他还能说自己不吃人么？</p>
<p>至于我家大哥，也毫不冤枉他。他对我讲书的时候，亲口说过可以“易子而食”；又一回偶然议论起一个不好的人，他便说不但该杀，还当“食肉寝皮”。我那时年纪还小，心跳了好半天。前天狼子村佃户来说吃心肝的事，他也毫不奇怪，不住的点头。可见心思是同从前一样狠。既然可以“易子而食”，便什么都易得，什么人都吃得。我从前单听他讲道理，也胡涂过去；现在晓得他讲道理的时候，不但唇边还抹着人油，而且心里满装着吃人的意思。</p>
<center><h3>六</h3></center><p>黑漆漆的，不知是日是夜。赵家的狗又叫起来了。</p>
<p>狮子似的凶心，兔子的怯弱，狐狸的狡猾，……</p>
<center><h3>七</h3></center><p>我晓得他们的方法，直捷杀了，是不肯的，而且也不敢，怕有祸祟。所以他们大家连络，布满了罗网，逼我自戕。试看前几天街上男女的样子，和这几天我大哥的作为，便足可悟出八九分了。最好是解下腰带，挂在梁上，自己紧紧勒死；他们没有杀人的罪名，又偿了心愿，自然都欢天喜地的发出一种呜呜咽咽的笑声。否则惊吓忧愁死了，虽则略瘦，也还可以首肯几下。</p>
<p>他们是只会吃死肉的！——记得什么书上说，有一种东西，叫“海乙那”的，眼光和样子都很难看；时常吃死肉，连极大的骨头，都细细嚼烂，咽下肚子去，想起来也教人害怕。“海乙那”是狼的亲眷，狼是狗的本家。前天赵家的狗，看我几眼，可见他也同谋，早已接洽。老头子眼看着地，岂能瞒得我过。</p>
<p>最可怜的是我的大哥，他也是人，何以毫不害怕；而且合伙吃我呢？还是历来惯了，不以为非呢？还是丧了良心，明知故犯呢？</p>
<p>我诅咒吃人的人，先从他起头；要劝转吃人的人，也先从他下手。</p>
<center><h3>八</h3></center><p>其实这种道理，到了现在，他们也该早已懂得，……</p>
<p>忽然来了一个人；年纪不过二十左右，相貌是不很看得清楚，满面笑容，对了我点头，他的笑也不像真笑。我便问他，“吃人的事，对么？”他仍然笑着说，“不是荒年，怎么会吃人。”我立刻就晓得，他也是一伙，喜欢吃人的；便自勇气百倍，偏要问他。</p>
<p>“对么？”</p>
<p>“这等事问他什么。你真会……说笑话。……今天天气很好。”</p>
<p>天气是好，月色也很亮了。可是我要问你，“对么？”</p>
<p>他不以为然了。含含胡胡的答道，“不……”</p>
<p>“不对？他们何以竟吃？！”</p>
<p>“没有的事……”</p>
<p>“没有的事？狼子村现吃；还有书上都写着，通红斩新！”</p>
<p>他便变了脸，铁一般青。睁着眼说，“有许有的，这是从来如此……”</p>
<p>“从来如此，便对么？”</p>
<p>“我不同你讲这些道理；总之你不该说，你说便是你错！”</p>
<p>我直跳起来，张开眼，这人便不见了。全身出了一大片汗。他的年纪，比我大哥小得远，居然也是一伙；这一定是他娘老子先教的。还怕已经教给他儿子了；所以连小孩子，也都恶狠狠的看我。</p>
<center><h3>九</h3></center><p>自己想吃人，又怕被别人吃了，都用着疑心极深的眼光，面面相觑。……</p>
<p>去了这心思，放心做事走路吃饭睡觉，何等舒服。这只是一条门槛，一个关头。他们可是父子兄弟夫妇朋友师生仇敌和各不相识的人，都结成一伙，互相劝勉，互相牵掣，死也不肯跨过这一步。</p>
<center><h3>十</h3></center><p>大清早，去寻我大哥；他立在堂门外看天，我便走到他背后，拦住门，格外沉静，格外和气的对他说，</p>
<p>“大哥，我有话告诉你。”</p>
<p>“你说就是，”他赶紧回过脸来，点点头。</p>
<p>“我只有几句话，可是说不出来。大哥，大约当初野蛮的人，都吃过一点人。后来因为心思不同，有的不吃人了，一味要好，便变了人，变了真的人。有的却还吃，——也同虫子一样，有的变了鱼鸟猴子，一直变到人。有的不要好，至今还是虫子。这吃人的人比不吃人的人，何等惭愧。怕比虫子的惭愧猴子，还差得很远很远。</p>
<p>“易牙蒸了他儿子，给桀纣吃，还是一直从前的事。谁晓得从盘古开辟天地以后，一直吃到易牙的儿子；从易牙的儿子，一直吃到徐锡林；从徐锡林，又一直吃到狼子村捉住的人。去年城里杀了犯人，还有一个生痨病的人，用馒头蘸血舐。</p>
<p>“他们要吃我，你一个人，原也无法可想；然而又何必去入伙。吃人的人，什么事做不出；他们会吃我，也会吃你，一伙里面，也会自吃。但只要转一步，只要立刻改了，也就是人人太平。虽然从来如此，我们今天也可以格外要好，说是不能！大哥，我相信你能说，前天佃户要减租，你说过不能。”</p>
<p>当初，他还只是冷笑，随后眼光便凶狠起来，一到说破他们的隐情，那就满脸都变成青色了。大门外立着一伙人，赵贵翁和他的狗，也在里面，都探头探脑的挨进来。有的是看不出面貌，似乎用布蒙着；有的是仍旧青面獠牙，抿着嘴笑。我认识他们是一伙，都是吃人的人。可是也晓得他们心思很不一样，一种是以为从来如此，应该吃的；一种是知道不该吃， 可是仍然要吃，又怕别人说破他，所以听了我的话，越发气愤不过，可是抿着嘴冷笑。</p>
<p>这时候，大哥也忽然显出凶相，高声喝道，</p>
<p>“都出去！疯子有什么好看！”</p>
<p>这时候，我又懂得一件他们的巧妙了。他们岂但不肯改，而且早已布置；预备下一个疯子的名目罩上我。将来吃了，不但太平无事，怕还会有人见情。佃户说的大家吃了一个恶人，正是这方法。这是他们的老谱！</p>
<p>陈老五也气愤愤的直走进来。如何按得住我的口，我偏要对这伙人说，</p>
<p>“你们可以改了，从真心改起！要晓得将来容不得吃人的人，活在世上。</p>
<p>“你们要不改，自己也会吃尽。即使生得多，也会给真的人除灭了，同猎人打完狼子一 样！——同虫子一样！”</p>
<p>那一伙人，都被陈老五赶走了。大哥也不知那里去了。陈老五劝我回屋子里去。屋里面全是黑沉沉的。横梁和椽子都在头上发抖；抖了一会，就大起来，堆在我身上。</p>
<p>万分沉重，动弹不得；他的意思是要我死。我晓得他的沉重是假的，便挣扎出来，出了一身汗。可是偏要说，</p>
<p>“你们立刻改了，从真心改起！你们要晓得将来是容不得吃人的人，……”</p>
<center><h3>十一</h3></center><p>太阳也不出，门也不开，日日是两顿饭。</p>
<p>我捏起筷子，便想起我大哥；晓得妹子死掉的缘故，也全在他。那时我妹子才五岁，可爱可怜的样子，还在眼前。母亲哭个不住，他却劝母亲不要哭；大约因为自己吃了，哭起来不免有点过意不去。如果还能过意不去，……</p>
<p>妹子是被大哥吃了，母亲知道没有，我可不得而知。</p>
<p>母亲想也知道；不过哭的时候，却并没有说明，大约也以为应当的了。记得我四五岁时，坐在堂前乘凉，大哥说爷娘生病，做儿子的须割下一片肉来，煮熟了请他吃，才算好人；母亲也没有说不行。一片吃得，整个的自然也吃得。但是那天的哭法，现在想起来，实在还教人伤心，这真是奇极的事！</p>
<center><h3>十二</h3></center><p>不能想了。</p>
<p>四千年来时时吃人的地方，今天才明白，我也在其中混了多年；大哥正管着家务，妹子恰恰死了，他未必不和在饭菜里，暗暗给我们吃。</p>
<p>我未必无意之中，不吃了我妹子的几片肉，现在也轮到我自己，……</p>
<p>有了四千年吃人履历的我，当初虽然不知道，现在明白，难见真的人！</p>
<center><h3>十三</h3></center><p>没有吃过人的孩子，或者还有？</p>
<p>救救孩子……</p>
<p><em>（原载《新青年》第四卷第五号，一九一八年五月十五日）</em></p>
<hr>
<p>鲁迅先生的《狂人日记》我曾在高中读过。如同鲁迅的其他文章一样，当时觉得晦涩难懂，只能当荒诞恐怖故事略读。虽然明白其中肯定有些深层的隐喻，但是想不明白。</p>
<p>昨天是五四运动一百周年，好奇心日报从 1919 年的报刊杂志上摘选了一系列文章更新在网站上，按照日报的说法，「我们今天的纪念，是直接拿来：100 年前，先行者如何看世界，如何设置议题，如何推动了中国进步」。</p>
<p>《狂人日记》便是其中一篇。我从 RSS 阅读器中读到，再点<a href="http://www.qdaily.com/articles/63252.html">原文链接</a>发现已被删除，于是搬运全文发表于本博客。看客诸君若尚未读过本文，推荐细读；若已读过，不妨重温一遍这篇振聋发聩的荒诞小说。</p>
<style>.copy-link{display:none!important}</style></div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/321/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/320/" target="_self">Let's talk about Clustering</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/320/" target="_self">
                <time class="text-uppercase">
                    April 25 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>This post is about clustering. I will make a short introduction of traditional methods, then talk about a magical algorithm published by Alex Rodriguez and Alessandro Laio on <a href="https://science.sciencemag.org/content/344/6191/1492.full">Science magazine</a>, 2014. I call it magical because it's simple yet powerful, and super intuitive. The principle behind it is really semantic.</p>
<p>Clustering, as a kind of unsupervised learning method, aims to divide dataset into some pieces (i.e. "classes"), making the <strong>intraclass difference</strong><sup id="fn_ref_1"><a href="#fn_1">1</a></sup> as small as possible while the <strong>interclass difference</strong><sup id="fn_ref_2"><a href="#fn_2">2</a></sup> as large as possible.</p>
<p>For example, the picture bellow shows 5000 points scattered on a 2-D plane, we humans can easily assign them into 15 groups, because there is an obvious distributing pattern of these points. The question is, how could computers finish this job?</p>
<p><figure class="pswp-item" style="flex: 50.0" data-width="100" data-height="100"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/54ba94e700b9b152723d423398fcef4d.png" alt="5000 points scattered on a 2-D plane" /><figcaption>5000 points scattered on a 2-D plane</figcaption></figure></p>
<h2>Traditional methods</h2>
<p>In the past few decades many algorithms have been developed just to finish this "simple" task, some of them are quite delicate and beautiful. However, depending on the rationale behind them, they all have some shortcomings like any other algorithm does. They are either slow or too complicated to implement, or just cannot finish the job.</p>
<p>The <strong>C-Means</strong> algorithm might be the most famous one of its kind. We randomly choose some points as cluster centers at first, then we assign points into some clusters by their "distance" to cluster centers, then calculate new centers to replace old ones. This procedure is accomplished by repeating those steps several times, until cluster centers do not move anymore. This method is inspirational, and many similar methods have been developed, such as <strong>Fuzzy C-Means</strong>, which uses a fuzzy matrix to weight the target function. This kind of algorithms are easy to implement and are simple to understand, but as been mentioned above, the initial cluster centers are very important, and results vary under different initial state. That makes these algorithms not robust enough, thus not reliable in some cases.</p>
<p>Another kind of algorithms are build upon statistics, such as <strong>Guassian Mixed Model (GMM)</strong> algorithm. It assumes that data points are just samples from some mixed Guassian models, therefore the clustering task is equal to estimate several Guassian models, to make the posterior probability as large as possible. Theoretical foundation of these algorithms are clear, mathematics makes them look reliable. However, initial state still affects the result, and most importantly, the basic assumption — "data points are just samples from some mixed Guassian models" — isn't always true. Another problem is, this algorithm could be very slow with large datasets.</p>
<p>Some other algorithms exist, like <strong>Hierarchical Clustering</strong>, which works fine under discrete feature values. It regards each points as a single cluster at first, then combines two clusters each time, repeat this step until the total number of clusters reduces to a certain level. It sounds simple, but again, it's slow with large datasets, and not robust enough.</p>
<h2>A new method</h2>
<p>Algorithms mentioned above are highlights of clustering methods. Most of them are iterative methods, and could be time consuming with large datasets. People have found an acceptable principle: a good clustering method is an algorithm which can fully summarize the common features of points, while making different clusters faraway from each other.</p>
<p>A new method was introduced by Alex Rodriguez and Alessandro Laio in 2014, their paper was published on Science. This already indicates that their algorithm must have something special, since papers in this field are hardly seen on magazines like Science. It is worth mentioning that deep learning researches were already super popular in 2014, which makes this algorithm even more admirable — it has absolutely nothing to do with deep learning.</p>
<p>This algorithm is based on two principles, <strong>only two</strong>:</p>
<ol>
<li><strong>Cluster centers are points with high "Local Density ($\rho$)"</strong></li>
<li><strong>Cluster centers are points with high "Relative Distance ($\delta$)"</strong></li>
</ol>
<h3>Local Density</h3>
<p>How to understand these two principles? Well, the first is relatively easy: cluster centers tends to have more points around them, than other regular none-center points. Imagine a leader of a team, or the head of a gang, they are always surrounded by many other "little guys".</p>
<p>For each point, we simply count the number of points around it, that is, closer than a predefined cut-distance — $d_c$:</p>
<p>$$\rho_i = \sum \chi(d_{ij} - d_c)$$</p>
<p>And we have :</p>
<p>$$\chi(x) = 1|_{x<0}, \chi(x)=0|_{x\ge 0}$$</p>
<p>Geometrically, this step equals to drawing a circle (or spherical surface with higher dimensions) using $d_c$ as radius and $point_i$ as center, then count the number of points inside the circle.</p>
<h3>Relative Distance</h3>
<p>This is a little more difficult to understand. Actually "Relative distance" means "<strong>minimum distance to points with higher local density</strong>", that is for each point $P_i$ with local density $\rho_i$, we calculate distances between $P_i$ and any other point $P_j$ with local density $\rho_j > \rho_i$, then use the minimal distance as the "Relative Distance" of $P_i$. But WHY?</p>
<p>We can easily understand why we choose points with high Local Density ($\rho$) as cluster center candidates — because points around them are compact. But don't forget, another criteria is also important for cluster centers: <strong>distance between clusters should be as large as possible</strong>. It is reasonable, think about it: if cluster centers are too close to each other, there must be huge overlap between clusters, that usually isn't ideal result.</p>
<p>Again, imagine a man who want to be a leader of a team, firstly he gathered a lot "little guys", then he must want to keep distance to those "bigger bosses", otherwise he might lose in competition. The Relative Distance ($\delta$) is used to measure the distance between $P_i$ and any other cluster center candidates, as explained, this value should be as large as possible. Therefore, $\delta_i$ for $P_i$ could be calculated as:</p>
<p>$$\delta_i = \min(d_{ij}) |_{\rho_j>\rho_i}$$</p>
<p>If $P_i$ already has the biggest $\rho$, just let:</p>
<p>$$\delta_i = \max(\rho_j) |_{j\ne i}$$</p>
<p>And $d_{ij}$ means Euclidean distance between $P_i$ and $P_j$.</p>
<h3>Implementation</h3>
<p>I implemented this algorithm using Matlab, guess how many lines of code does it need?</p>
<div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>[centers_o, Rho_o, Delta_o] <span class="p">=</span><span class="w"> </span><span class="nf">fsfdp</span><span class="p">(</span>dataset_i, NumCategory_i, dc_i<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c">%%%%%</span>
    <span class="c">% Clustering by Fast search and find of density peaks</span>
    <span class="c">% AlanDecode</span>
    <span class="c">% </span>
    <span class="c">% dataset_i: N * D</span>
    <span class="c">% NumCategory_i: number of categories</span>
    <span class="c">% dc_i: cut distance</span>

    <span class="c">%% Dataset</span>
    <span class="n">dataset</span> <span class="p">=</span> <span class="n">dataset_i</span><span class="p">;</span>
    <span class="n">datasetSize</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>
    <span class="n">NumCategory</span> <span class="p">=</span> <span class="n">NumCategory_i</span><span class="p">;</span>

    <span class="c">%% Algorithm</span>

    <span class="c">% Calc distance between points</span>
    <span class="n">distMat</span> <span class="p">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>
    <span class="n">distMat</span> <span class="p">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">distMat</span><span class="p">);</span>

    <span class="c">% Calc Rho (local density)</span>
    <span class="n">Rho</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">datasetSize</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span><span class="n"></span>
<span class="n">    for </span><span class="s">idx = 1:datasetSize(1)</span><span class="p"></span>
        <span class="n">dists</span> <span class="p">=</span> <span class="n">distMat</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="p">:);</span>
        <span class="n">Rho</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">dists</span><span class="p">(</span><span class="n">dists</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="n">dists</span> <span class="o">&lt;</span> <span class="n">dc_i</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span><span class="n"></span>
<span class="n">    end</span>

<span class="n">    </span><span class="s">% Sort</span><span class="p"></span>
    <span class="p">[</span><span class="o">~</span><span class="p">,</span> <span class="n">rhoIndex</span><span class="p">]</span> <span class="p">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span> <span class="s">&#39;descend&#39;</span><span class="p">);</span>

    <span class="c">% Calc Delta (minimum distance between one point </span>
    <span class="c">% and any other point with higher density)</span>
    <span class="n">Delta</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">datasetSize</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span><span class="n"></span>
<span class="n">    for </span><span class="s">idx = 1:datasetSize(1)</span><span class="p"></span>
<span class="n">        if </span><span class="s">idx == 1</span><span class="p"></span>
            <span class="c">% point with highest rho</span>
            <span class="n">index</span> <span class="p">=</span> <span class="n">rhoIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

            <span class="c">% use highest distance as Delta</span>
            <span class="n">dists</span> <span class="p">=</span> <span class="n">distMat</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">:);</span>
            <span class="n">Delta</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">);</span><span class="n"></span>
<span class="n">        else</span>
<span class="n">            </span><span class="s">% current point</span><span class="p"></span>
            <span class="n">index</span> <span class="p">=</span> <span class="n">rhoIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

            <span class="c">% points with higher rho</span>
            <span class="n">rhoIndexSlice</span> <span class="p">=</span> <span class="n">rhoIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">p1</span> <span class="p">=</span> <span class="n">dataset</span><span class="p">(</span><span class="n">rhoIndexSlice</span><span class="p">,</span> <span class="p">:);</span>

            <span class="c">% calc distance</span>
            <span class="n">p2</span> <span class="p">=</span> <span class="nb">repmat</span><span class="p">(</span><span class="n">dataset</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">:),</span> <span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">dists</span> <span class="p">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">sum</span><span class="p">((</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

            <span class="c">% minimal distance</span>
            <span class="n">Delta</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">);</span><span class="n"></span>
<span class="n">        end</span>
<span class="n">    </span><span class="s">end</span><span class="p"></span>

    <span class="c">% Find centers, composite Rho and Delta</span>
    <span class="n">Temp</span> <span class="p">=</span> <span class="n">Rho</span><span class="o">.^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Delta</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">[</span><span class="o">~</span><span class="p">,</span> <span class="n">tempIndex</span><span class="p">]</span> <span class="p">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">Temp</span><span class="p">,</span> <span class="s">&#39;descend&#39;</span><span class="p">);</span>
    <span class="c">% highest [NumCategory] values</span>
    <span class="n">tempIndexSlice</span> <span class="p">=</span> <span class="n">tempIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NumCategory</span><span class="p">);</span>
    <span class="n">centers</span> <span class="p">=</span> <span class="n">dataset</span><span class="p">(</span><span class="n">tempIndexSlice</span><span class="p">,</span> <span class="p">:);</span>

    <span class="c">% Return</span>
    <span class="n">Rho_o</span> <span class="p">=</span> <span class="n">Rho</span><span class="p">;</span>
    <span class="n">Delta_o</span> <span class="p">=</span> <span class="n">Delta</span><span class="p">;</span>
    <span class="n">centers_o</span> <span class="p">=</span> <span class="n">centers</span><span class="p">;</span><span class="n"></span>
<span class="n">end</span>
</pre></div>
<p>You can see the core part contains less than 50 lines of code, it is so concise that I even doubted myself. But the result reassured me：</p>
<p><figure class="pswp-item" style="flex: 117.54756871035941" data-width="1112" data-height="473"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/91e42a37259c862eff50b74848c93363.jpg" alt="Result of FSFDP algorithm" /><figcaption>Result of FSFDP algorithm</figcaption></figure></p>
<p>Cluster centers are drawn using blue circles on the right-hand figure. And we can clearly see 15 points with high $\rho$ and $\delta$ one the left-hand figure. This algorithm is not iterative, the most time consuming step is sorting. This is inevitable though, because the sorting result is necessary for calculating $\delta$.</p>
<hr>
<p>Dataset in this post could be downloaded <a href="/resources/s1.txt">here</a>, just load it in Matlab. It includes coordinates of 5000 2-D points.</p>
<hr><div class="footnotes"><ol><li id="fn_1">the differences of data points in the same class <a no-style href="#fn_ref_1">↩</a></li><li id="fn_2">the differences of data points in different classes <a no-style href="#fn_ref_2">↩</a></li></ol></div></div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/320/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/317/" target="_self">春天、联谊、新耳机</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/317/" target="_self">
                <time class="text-uppercase">
                    April 16 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>很久没写这个日常系列了。倒不是没有可写的东西，而是可写的太多太杂，反而不知道该如何切入。</p>
<p>我读林檎的<a href="https://underwaternya.github.io/2019/04/07/why-we-read-fiction.html">这篇博客</a>，类比其中的说法<sup id="fn_ref_1"><a href="#fn_1">1</a></sup>后发现在写博客这个层面上我竟也陷入了 naive 这个类别：即渐渐变得更愿意在博客上写所谓的技术文，也就是「干货」，而自己内心的杂思却难以下笔。</p>
<p>技术文固然有技术文的价值，分享技术是我写博客的初衷之一。但既然我同时有一个更长远、更稳定<sup id="fn_ref_2"><a href="#fn_2">2</a></sup>的 <a href="https://wiki.imalan.cn/">Wiki 站点</a>，当前这个博客可以变得更<ruby>多彩<rp>(</rp><rt>混乱</rt><rp>)</rp></ruby>一些。</p>
<p>写心中随想是很困难的。技术自身就蕴含着逻辑性，只要我自己懂了，写出来的东西总不至于乱七八糟；但是心中的杂思却不同。逻辑性并不是胡思乱想的特征，相反，正是随意与没有逻辑才使白日梦生机勃勃。</p>
<p>因此写作者会经受巨大的考验。从一团乱麻中理出线头，然后娓娓道来；挖掘出藏在深处的关联，悟出这些念头的偶然性与必然性。这几乎是艺术与哲学的范畴了。</p>
<p>另外，蔡琴是这项活动的绝配。</p>
<hr>
<p>北京的春天确实短暂，今天我就脱下了外套，上身只剩一件短袖。早晨通勤路上的老者惊讶地对我说「小伙儿身体真好！我这还穿着毛衣，你就只穿短袖了！」，我才意识到街上确实只有我穿得这么单薄。就当是 23 岁的任性吧。</p>
<p>春天最深刻的记忆就是过敏与杨絮。今年我做好了准备，开瑞坦早早地买好、口罩早早地备好，因此没有受太多苦。</p>
<p>今年春天的记忆可加上一条：与北京师范大学教育学部的女生们联谊。联谊会由我所在学院与北师教育学部的研究生会共同举办，地点在北师校园。男生们下午一点半从学校出发，在北师英东楼集合，待男男女女都到齐后便开始主要活动：打卡闯关游戏。主办方在北师校园各处设置打卡点，每到一点即可获取下一点的线索。两男两女共四人一组，通力合作解谜闯关，用时少者获胜。</p>
<p>与我一组的男生就住我对面寝室，但平时并没有太多来往，借这次机会也相互了解了一些（即在楼道相遇时能不尴尬地打招呼了）。我和他都以为这个打卡游戏是边走边聊的休闲活动，顺道欣赏春天的北师校园，哪曾想两位女生相当期待胜利，游戏开始便一路狂奔，我一度吃不消（因为脚上有伤），不得不满怀歉意地要求慢一些。</p>
<p>慢下来后才有机会闲聊与参观校园。北师校园绿化极佳，树木、灌木、花草各有特色，刚好是开花的时节，真是赏心悦目，但可惜并没有留下太多好看的照片。令我印象最深的是北师数量惊人的郁金香，以及路边大片大片的不知名小花。</p>
<div class="photos">
<figure class="pswp-item" style="flex: 74.98879426266248" data-width="3346" data-height="2231"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/c3979b662855a6df012732fa4dca3598.jpg" alt="路边小花" /><figcaption>路边小花</figcaption></figure>
<figure class="pswp-item" style="flex: 74.98879426266248" data-width="3346" data-height="2231"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/a584e2bc88af47bcbfe8a8cc8f40f0c9.jpg" alt="大片郁金香" /><figcaption>大片郁金香</figcaption></figure></div><p>两位女生都很活泼开朗，交谈起来没有生涩的感觉。我发现其中一位相当博学，对教育、植物、形势、技术都有了解。聊天得知她的研究方向是「用技术解决教育问题」<sup id="fn_ref_3"><a href="#fn_3">3</a></sup>，还有一位老师与 Apple 合作开发 AR/VR 相关产品，涉及的领域包括计算机图形学、机器学习、数据挖掘等等，我觉得非常酷。另外最令我羡慕的是她所在的实验室分工相当明确，从设计到编码到测试到反馈迭代都有完善的流程和明确的分工，不禁感叹我所处的工科院校实验室竟然会在这上面落了下风。</p>
<p>另一位的研究范围我没有听得很明了。我的理解是类似「为社会谱基调」的工作。大概意思是目前的教育培养出的人才从根本上就是不利于社会与环境的可持续发展的，她的研究就是寻求一种教育方式上的<ruby>范式转换<rp>(</rp><rt>Paradigm Shift</rt><rp>)</rp></ruby>，从教育的角度为环境问题与可持续发展问题求一个解。当然这不容易，她也觉得这有些空洞。但相反，我觉得这很重要。大概是一两年前，我在火车上有感而发，发过一条微博（准确的内容记不清了）：</p>
<blockquote><p>理工科素养是成为创造者的要素，但是文科素养是一个人行事风格的基调。这种「基调」是会扩散到周围环境的。</p>
</blockquote>
<p>教育就是在帮人谱基调。这在我看来是非常重要、非常有意义的一件事。真心期望这位女生能在该领域取得一些进展。</p>
<p>活动结束后四人一块儿去北师一家饭店吃了晚饭。菜似乎点多了，最后在女生的高压下吃得八九不离十了（好撑）。附上一张合照～</p>
<blockquote><p>算了，还是不放了</p>
</blockquote>
<p>另，打卡闯关环节本组<del>在女生们的 carry 下</del>斩获一等奖?。</p>
<hr>
<p>都说不要在晚上做任何购买决策，果不其然，没忍住入手了铁三角家的 LS50IS 入耳式耳机……</p>
<p>我在<a href="https://blog.imalan.cn/archives/307/">这篇</a>文章的评论区里说我受不了任何入耳的东西，因而与很多高端耳机无缘，但这次仿佛是找到了入耳式耳机的正确打开方式。</p>
<p><figure class="pswp-item" style="flex: 75.0" data-width="4032" data-height="2688"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/2bb719a800874703a7b0661242aeb3d2.jpg" alt="红色款，形象气质佳" /><figcaption>红色款，形象气质佳</figcaption></figure></p>
<p>一者，LS50IS 是耳挂式，会比普通的入耳戴的稳固一些；另一方面 LS50IS 相比起 im 系列导管短了一丢丢，这也提升了佩戴舒适感。经过这一天的使用，发现我对入耳式耳机的听诊器效应还是有些不适应，但整体上是可以接受的。</p>
<p>音质是一大亮点。入耳式耳机隔音性能远胜于平头，因此在营造声场、解析力等性能上有得天独厚的优势。蔡琴的《渡口》里那几声鼓和梆子听的我热泪盈眶。不过评价音质是文学家的领域，我不擅长。</p>
<p>关于隔音，还记得戴着 AirPods 乘地铁的体验吗？那时我的手机音量会开到近 70% 才能听清声音，这已经是相当危险的数值了。但是 LS50IS 只需要 40% 左右，要知道，这甚至都不是一副降噪耳机。另外我办公室工位旁边有一台装了 4 张 1080 Ti 的主机，24 小时不断输出噪音，LS50IS 的隔音性能也让我相当受用。</p>
<p>其实不久之前我还入手了一副平头：拜亚动力 DP100。早就知道平头塞爱好者生存环境很差，选购找评测的时候确实深感不易。优质的平头都已经停产，只剩下创新 Air 等几款扛把子在售；新的中高端耳机几乎没有平头，DP100 也不过是 200 RMB 的价位，实在称不上是中端耳机。刚拿到的时候还是相当满意的，从声音到外形都物价相符，后来发现不知道为什么，也许是因为材料，这款耳机很容易起静电。你能想象耳机在你耳朵里放电打火花吗？所以不得不结束了 DP100 短暂的服役期。</p>
<p>最后思来想去只有苹果自带的 EarPods 是属于我的理想平头。当然也包括 AirPods，毕竟二者外形相同，佩戴感也相同，音色差别不大。</p>
<hr>
<p>按理说我是没空写这篇日志的，因为还有许多事情没做完。接下来又要去南京出差几日，待回北京肯定是身心疲惫。不过趁着联谊记忆还在，新耳机的新鲜感尚未消退，还是赶紧把当前的心绪记录下来。</p>
<p>那么，下次再见。</p>
<hr><div class="footnotes"><ol><li id="fn_1">naive reader、imaginative investigator、dreamer / interpreter <a no-style href="#fn_ref_1">↩</a></li><li id="fn_2">托管于 Github Pages 上 <a no-style href="#fn_ref_2">↩</a></li><li id="fn_3">引用原文 <a no-style href="#fn_ref_3">↩</a></li></ol></div></div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/317/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/308/" target="_self">更进一步的夜间模式之细节一二</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/308/" target="_self">
                <time class="text-uppercase">
                    April 01 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>VOID 2.0 版本起支持了夜间模式，其控制逻辑基础是 Jad 的<a href="https://imjad.cn/archives/code/add-night-mode-to-blog">这篇文章</a>。最近在 Hran 那边看到了 macOS 10.14.4 及以上的 Safari 浏览器中通过<ruby>媒体查询<rp>(</rp><rt>media query</rt><rp>)</rp></ruby>获得用户操作系统颜色偏好的<a href="https://get233.com/archives/support-macOS-dark-mode-in-safari-web.html">方法</a>，并且受到 iOS Nightshift 功能的启发，我决定使这个功能更上一层楼。</p>
<h2>控制逻辑</h2>
<p>本文主要关注功能逻辑，不讨论夜间模式样式方面的内容。为了得到良好的体验，这个功能需要前后端结合实现。</p>
<p>后端添加一个颜色模式的设置，分为「日间模式」、「夜间模式」、「自动模式」，其中：</p>
<ul>
<li><p>日间模式：前后端均不做任何处理</p>
</li>
<li><p>夜间模式：后端直接输出 class 至 HTML 中，前端不处理</p>
</li>
<li><p>自动模式：</p>
<p>首先，为了防止前端闪烁，后端应该根据是否存在 cookie 来直接输出对应的 class 在 HTML 中。另外，前端的逻辑如下：</p>
<ol>
<li>若操作系统为深色，则切换至深色，并设置较长的 cookie 过期时间，否则进行下一步</li>
<li>若能够获得地理位置，则计算该地日出日落时间，并且：<ul>
<li>若处于夜晚，则切换至夜间模式并设置 cookie，至日出时 cookie 过期</li>
<li>若处于白天，切换至日间模式，清除 cookie</li>
</ul>
</li>
<li>若不能获得地理位置，则以固定的时间作为日出日落时间，切换逻辑与 2 中相同</li>
</ol>
</li>
</ul>
<p>厘清逻辑后实现并不困难。剩下的部分说说实现中较为关键的步骤。</p>
<h2>Cookie 的访问与设置</h2>
<p>Cookie 用于在前端存储一些信息，常用于鉴权、保存标志位等。只要浏览器没有禁用 Cookie，前端的 Cookie 会随网络请求发送至后端，这使我们可以利用该技术为各用户（浏览器）提供针对性的服务。</p>
<p><strong>在前端设置一个 Cookie：</strong></p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">cookieString</span> <span class="o">=</span> <span class="s1">&#39;[NAME]=[VALUE];max-age=[AGE];path=[PATH]&#39;</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookieString</span><span class="p">;</span>
</pre></div>
<p>其中包括 <code>[NAME]</code>、<code>[AGE]</code>、<code>[PATH]</code> 参数，分别表示 Cookie 名，过期时间（秒），作用域。例如，设置 <code>theme_dark=1</code>，过期时间 1 小时，作用域为 <code>/</code>：</p>

<pre><code>var cookieString = 'theme_dark=1;max-age=3600;path=/';
document.cookie = cookieString;</code></pre>
<p><strong>在后端读取一个 Cookie（PHP）：</strong></p>
<div class="highlight"><pre><span></span><span class="x">$_COOKIE[&#39;theme_dark&#39;]; // = &#39;1&#39;</span>
</pre></div>
<p>其结果为一个字符串。更严谨的操作中需要先检查 <code>$_COOKIE</code> 数组中是否包含 <code>theme_dark</code> 字段。</p>
<h2>操作系统深色模式检查</h2>
<p>由于这个属性尚没有 JS API，Hran 给出了一个迂回方法。首先设定 CSS 属性：</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">dark-mode-state-indicator</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="p">:</span> <span class="mi">-999</span><span class="kt">em</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">-999</span><span class="kt">em</span><span class="p">;</span>
  <span class="k">z-index</span><span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">@</span><span class="k">media</span> <span class="o">(</span><span class="nt">prefers-color-scheme</span><span class="o">:</span> <span class="nt">dark</span><span class="o">)</span> <span class="p">{</span>
  <span class="p">.</span><span class="nc">dark-mode-state-indicator</span> <span class="p">{</span>
    <span class="k">z-index</span><span class="p">:</span> <span class="mi">11</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>前端使用 JS 检查：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">getDeviceState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">zIndex</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 现代浏览器</span>
        <span class="nx">zIndex</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s1">&#39;z-index&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ie8-</span>
        <span class="nx">zIndex</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">[</span><span class="s1">&#39;z-index&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">zIndex</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">getPrefersDarkModeState</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indicator</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">indicator</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;dark-mode-state-indicator&#39;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">indicator</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">getDeviceState</span><span class="p">(</span><span class="nx">indicator</span><span class="p">)</span> <span class="o">===</span> <span class="mi">11</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">getPrefersDarkModeState</span><span class="p">();</span> <span class="c1">// true or false</span>
</pre></div>
<h2>地理位置获取</h2>
<p>根据 MDN：</p>
<blockquote><p><code>Navigator.geolocation</code> 只读属性返回一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Geolocation"><code>Geolocation</code></a> 对象，通过这个对象可以访问到设备的位置信息。使网站或应用可以根据用户的位置提供个性化结果。</p>
</blockquote>
<div class="notice">需注意，此 API 仅在 HTTPS 协议下、现代浏览器中可用，并且需要用户授权。根据我的实践，该 API 在不同浏览器中的行为并不是那么一致，若是更严肃的场合，可能需要使用百度等服务的 workaround。</div><p>检查浏览器是否支持该 API：</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;geolocation&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">;</span> <span class="c1">// true or false</span>
</pre></div>
<p>获取用户的位置信息：</p>
<div class="highlight"><pre><span></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">){</span>
  <span class="c1">// success</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">position</span><span class="p">);</span>
<span class="p">},</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="c1">// failed</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><code>getCurrentPosition</code> 方法接受两个回调函数，第一个是成功时的回调，第二个是出错时的。出错时的回调中可以根据 <code>data.code</code> 获取出错原因，包括：</p>
<ol>
<li>PERMISSION_DENIED</li>
<li>POSITION_UNAVAILABLE</li>
<li>TIMEOUT</li>
<li>UNKNOWN_ERROR</li>
</ol>
<p>其中 <code>PERMISSION_DENIED</code> 表示用户手动禁止了网站访问位置，为了良好的体验，开发者应该向用户说明为什么会需要访问位置以及会如何使用位置信息，然后祈祷用户能重新赋予网站该权限。</p>
<h2>时间计算与比较</h2>
<h3>日出日落时间</h3>
<p>这个模块还是相对比较复杂的，其实我目前也并没有搞懂。但是令人开心的是已经有人为我们造好了轮子：<a href="https://github.com/Triggertrap/sun-js">Triggertrap/<strong>sun-js</strong></a>。这个库为原生的 Date 类注入了两个新的方法：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunset</span><span class="p">(</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">longitude</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunrise</span><span class="p">(</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">longitude</span><span class="p">);</span>
</pre></div>
<p>返回值是 Date 对象。结合 Geolocation，获取方法如下：</p>
<div class="highlight"><pre><span></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunset</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunrise</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<h3>比较时间</h3>
<p>sun-js 库得到的日出与日落时间根据当前时间不同不一定是当天的时间，例如晚间获取的日出时间其实是第二日的日出时间。考虑到 24 小时内日出日落时间不会有太大变化，为了方便比较，将日出日落时间均转换至同一天（当天），并且只精确至分钟。</p>
<div class="highlight"><pre><span></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">){</span>
  <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunset</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
  <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunrise</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
  <span class="c1">// 全部转换至当天</span>
  <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">setHours</span><span class="p">(</span><span class="nx">sunset</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span> <span class="nx">sunset</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span> <span class="mi">0</span><span class="p">));</span>
  <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">setHours</span><span class="p">(</span><span class="nx">sunrise</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span> <span class="nx">sunrise</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<p>如此确定当前是否处于夜间：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
<span class="c1">// 格式化为小时</span>
<span class="kd">var</span> <span class="nx">sunset_s</span> <span class="o">=</span> <span class="nx">sunset</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">sunset</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">sunrise_s</span> <span class="o">=</span> <span class="nx">sunrise</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">sunrise</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">current_s</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nx">current_s</span> <span class="o">&gt;</span> <span class="nx">sunset_s</span> <span class="o">||</span> <span class="nx">current_s</span> <span class="o">&lt;</span> <span class="nx">sunrise_s</span><span class="p">){</span>
  <span class="c1">// 夜间</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
  <span class="c1">// 日间</span>
<span class="p">}</span>
</pre></div>
<p>然后计算当前距离日出的时间：</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="nx">current_s</span> <span class="o">&gt;</span> <span class="nx">sunset_s</span><span class="p">)</span> <span class="c1">// 如果当前为夜晚，日出时间应该切换至第二日</span>
  <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">sunrise</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600000</span><span class="o">*</span><span class="mi">24</span><span class="p">);</span>
<span class="c1">// 现在距日出还有 (s)</span>
<span class="kd">var</span> <span class="nx">toSunrise</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sunrise</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span> <span class="c1">// 秒</span>
</pre></div>
<p>这个时间就应该作为 Cookie 的过期时间，至日出时，该 Cookie 过期，网站则平滑地切换至日间模式。</p>
<h2>代码</h2>
<p>比较冗长，没必要贴在这里。我把代码摘出来建了一个 Gist，你可以点击查看：<a href="https://gist.github.com/AlanDecode/8b9333c28366b7af0bf0437e90a587f9">前往</a>。</p>
<hr>
<h2>2019-04-06 更新</h2>
<p>事实证明利用精确的位置来计算日出与日落大材小用了，并且随之而来的授权弹窗更是让浏览体验大打折扣。在<a href="https://blog.imalan.cn/archives/308/comment-page-1#comment-1993">评论区</a>的建议下，增加了利用时区来获取大概位置，并计算相应日出日落时间的方法。</p>
<p>核心的功能依赖 <a href="https://bitbucket.org/pellepim/jstimezonedetect">jsTimezoneDetect</a>，通过该库获取到时区名称后，将其转换为大致的位置（即时区名称对应城市的位置），然后再按照前文所述方法计算对应的日出与日落时间。我制作了一个时区名称到经纬度的转换表，<a href="https://gist.github.com/AlanDecode/9e05e4d1ed50160d012e6a3f7959c0c5">点击这里查看</a>。</p>
<p>如我在评论区中所述，仅使用时区来确定日出日落时间是不精确的，许多国家或地区只用一个时区（比如中国），但是从东到西时间差会很大（中国达到 4 小时之多）。不过权衡一下授权弹窗带来的差劲体验，这种误差也许可以接受吧。</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/308/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/307/" target="_self">与电脑心连心？</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/307/" target="_self">
                <time class="text-uppercase">
                    March 23 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>我一直以来都有工作时听音乐的习惯，这似乎已经成了一种仪式。早上到办公室必然要正襟危坐戴上耳机才能进入工作状态，否则人就像漂浮在空中，无法静下心来。最初我认为是因为喜欢听音乐，毕竟尝试过使用白噪音来代替音乐，却发现效果不佳。但仍然有两个现象让我怀疑这一点。</p>
<p>一是我经常戴上耳机却忘了打开音乐。说来奇怪，白噪音不起作用，但是无声却可以。这时候耳机线就像是一条锁链，把我以及我的心拴在桌前。二是用于听音乐的设备必须是我的工作设备。有几次我一边工作一边使用 AirPods 连接手机听音乐，竟然效果全无，反倒让我更加心烦意乱且无法专注。</p>
<p>这个问题可以归结于到底什么才是「沉浸式体验」。厂商们喜欢宣称更大的屏幕就是沉浸式体验，要多大呢？大到 VR 的地步。也就是你视野所及都是屏幕。由此看来沉浸式体验就是要隔绝外界的信息，然后重新创造一个只属于你的新世界。</p>
<p>此事不要狭义地理解：「屏幕」不必要是视觉层面上的，触觉、听觉也可以。因此回到本文的开头，一副源源不断流淌出乐音的耳机就为我准备了这样的一个世界，处在这个世界中的我不必理会任何外界噪音，也不必关心任何外界的纷争。耳机成为了一层保护膜，把我层层裹挟在乐音中，为我提供办公环境下难得的安全感。</p>
<p>但是连接着手机的 AirPods 不行。大概要维持这种排他性的环境对客体数量也是有要求的：只能有我和我的工作设备。AirPods 作为第三者进入这个环境，这便成为了保护膜的缺陷点。我和电脑二者齐心，把美妙的状态维持下去。</p>
<p>听上去像我和电脑进入了短暂的热恋。这太色情了。</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/307/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/306/" target="_self">关于 iPad Air、iPad mini 重回产品线</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/306/" target="_self">
                <time class="text-uppercase">
                    March 18 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>我感觉 Apple 近两年有些迷惑。</p>
<p>尝试了不少新的东西：12 寸 MacBook、iPhone X 等等，但结果却不是很如意。提高 iPhone 售价导致销售疲软，12 寸 MacBook 我看市场反响也相当一般。</p>
<p>从另一个侧面也能看出端倪。Apple 推出了一些试水产品，让产品线过于复杂。除了 12 寸 MacBook，9.7 寸 iPad Pro 也是一例：这是最孤独的一款 iPad Pro 了。去年推出的 iPad 2018 一时叫好又叫座，如今又想起了久未更新的 iPad Air、iPad mini，导致现在的 iPad 产品线在我看来相当尴尬。10.5 寸的新 iPad Air 与 iPad 2018 两者如何取舍？作为消费者的我其实很难做决定，十有八九 2018 款 iPad 也会成为只有一代的产品。</p>
<p>值得注意的是 Apple 不停地推出新的产品，但在这些尝试之后总又重新启用旧产品线。MacBook Air、Mac mini、iPad Air、iPad mini 都是例子，实在给我一种「还是老产品线能打」的感觉。近几年购买 Apple 的东西需要慎之又慎，产品线变动如此频繁，谁也不愿意 49 年入国军，对吧？</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/306/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/304/" target="_self">记一次头疼的 Debug</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/304/" target="_self">
                <time class="text-uppercase">
                    March 17 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>这是前天（2019-03-15）的事了。手里的一个项目出了个奇怪的问题：在 Win 7 上一切正常，但是在 Win 10 上 Release 模式下<strong>随机</strong>出现不能启动的问题。Debug 模式没问题，同时日志中没有异常记录、控制台一片祥和。之前客户那边一直使用 Win 7 的环境，现在要购置新的机器，市场上适合 Win 7 的选择不多了，所以我们这边只能把项目适配到 Win 10。于是我开始着手解决这个问题。</p>
<p>由于 Debug 模式下一切正常，我首先想到的是编译器优化导致的问题。于是我尝试将编译器 <code>/O2</code> 选项更改为 <code>/Od</code>，<code>/MD</code> 更改为 <code>/MDd</code>，并将 <code>/GM</code> 改为 <code>/GM-</code>，然后重新生成，问题依旧。基本可以排除编译器的问题了，也就是说是代码自身的问题。</p>
<p>这时候我心里一凉，因为好像遇到了最难调试的情况。项目是老项目，也许之前的人编码习惯比较差？于是我将编译警告等级改到 <code>W3</code>，重新编译，不出所料控制台立刻被几千个 C4096 淹没，而且禁掉 C4096 之后还有一大堆 Warning。难受。</p>
<p>我坐正，嘬了一口咖啡，平复一下心情，决定先把出错位置找到。Release 模式下不能（当然并不是完全不能）设置断点，而且在当前情况下设置断点并没有用，程序根本没有抛出任何异常！只好用 <code>cout</code> 一步步地试。漫长又枯燥的两小时就这样过去了。</p>
<p>最终定位到的出错代码是一段老代码，让我想打人，形如：</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ClassA</span><span class="p">{</span>
    <span class="n">ENUM</span> <span class="n">m_Type</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">ClassA</span><span class="o">*</span> <span class="n">get</span><span class="p">(</span><span class="n">ENUM</span> <span class="n">type</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">m_Type</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{...}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>


<span class="n">ENUM</span> <span class="n">type</span><span class="p">;</span>
<span class="n">ClassA</span> <span class="nf">obj_ClassA</span><span class="p">();</span>
<span class="p">...</span>
<span class="n">obj_ClassA</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</pre></div>
<p>ClassA 的 <code>get(ENUM type)</code> 方法中对传入参数 <code>type</code> 做了判断，当 <code>type</code> 与 <code>m_Type</code> 相等时直接返回 <code>this</code>，免去后续的初始化。但是问题是，实参 <code>type</code> 没有显式地初始化，也就是说在运行时初始值不确定。</p>
<p>某些情况下，这些没有初始化的值是随机的，事先不能确定；但在一些情况下，依照平台的不同，可能会初始化为 0 或者其它值。因此有一定的机会 <code>type</code> 与 <code>m_Type</code> 从一开始就是相等的，使这个类根本没有经过初始化，导致了后续的 bug。至于为什么没有抛出异常，也是代码不规范导致的。说实话这根本不是一个合格程序员该犯的错误。任何变量都应该手动地初始化，这是基本素养。发现问题之后的 fix 其实很容易。</p>
<p>这次 Debug 给我的启示是在任何时候都要注意代码规范，养成良好的编码习惯。其实这种问题在开发之初就应该查出来，可见这个项目一开始就根本没有合理的 review 和测试环节。几千上万行的代码尚且好说，当项目规模上升到 10 万行左右这种问题找起来就如同大海捞针了。</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/304/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/303/" target="_self">Tp2MD：导出 Typecho 文章与页面</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/303/" target="_self">
                <time class="text-uppercase">
                    March 16 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>项目地址：<a href="https://github.com/AlanDecode/Typecho-Plugin-Tp2MD">Typecho-Plugin-Tp2MD</a>。</p>
<p>一边听歌一边写了这个插件，作为工作之余的消遣。这个插件可以将 Typecho 中的页面、文章导出到 Markdown 文件中，并且支持将自定义字段、slug、分类、标签、标题、作者等等 metadata 以 YAML front-matter 的形式存储在文件顶部。同时也支持将文章按分类放在不同文件夹中。</p>
<p>除了作为文章备份使用，对想要将博客迁移到 Hexo 等平台的同学来说这个插件可能也会有用。</p>
<p>LICENSE：MIT © <a href="https://github.com/AlanDecode">AlanDecode</a>。</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/303/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/291/" target="_self">编舟记</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/291/" target="_self">
                <time class="text-uppercase">
                    March 10 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>若要你解释「右」这个词，你会如何作答？</p>
<p>《编舟记》刻画了一本名叫《大渡海》的辞典从立项到出版的过程，历时 12 年之久。我昨天午夜看完同名电影，直到现在不能释怀，三浦紫苑的剧本加上几位演员的精湛表演给了我极大的震撼。</p>
<p>虽说作品本身讲的是辞典编纂的故事，但实则是对「宅人」的礼赞。三浦女士大概对这类小众而执着的工种有特别的偏爱，《真幌站前》讲的也是便利屋这种说不上高端的职业。这前后是说得通的，越是小众的工种，越无法被大众理解，即使如此还要一门心思投身其中的人，可说是值得尊敬的职人。这其中出神入化者，可称为「宅人」。</p>
<p>由于荒木编辑退休而被调来的马缔从一开始就被定性为「宅」：迟钝而不善交际，甚至由于名字谐音而被同事叫做「认真先生」。不过荒木的一句话点出了重点：</p>
<p><figure class="pswp-item" style="flex: 88.93058161350844" data-width="1896" data-height="1066"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/c281babb88cb33745ff7d6163c9e7a61.png" alt="不认真的人，编不了辞典" /><figcaption>不认真的人，编不了辞典</figcaption></figure></p>
<p>这么说吧：不认真的人什么也干不了。主编也好，荒木也好，香具矢也好，造纸工人也好，他们看上去都只是正正经经的社会人，然而在我看来都是不折不扣的「死宅」，中二感爆棚。</p>
<blockquote><p>其实昨天我去参加了联谊，听到的全是些新词，真是度过了一段有意义的时光。</p>
</blockquote>
<p>能说出上面这一段话的人，恐怕是要被骂成「直男癌」的吧。联谊会上不推杯换盏谈天说地，倒是关注什么「新词」，这与无线电爱好者、铁路爱好者、字体排印爱好者等等 maniac 别无二致，而这些统统都是大概率会被视为「异类」的人。</p>
<p>我<a href="https://blog.imalan.cn/archives/225/">说过</a>我喜欢「宅」所蕴含的精神属性。这个词用来挖苦不善交际、活在自己世界里的人，从一开始就是纯粹的贬义。不过令我感到<ruby>意外<rp>(</rp><rt>欣慰</rt><rp>)</rp></ruby>的是，这反倒是成了现代社会所缺乏的一种特质。社会大可对宅人宽容一些，其实人浮于事的一个原因便是人们找不到自己所愿意投身的事业，换言之，找不到自己的「宅点」。</p>
<p>无论是电影里的马缔，还是他一心学习厨艺的女友，一旦宅起来都很帅气：</p>
<p><figure class="pswp-item" style="flex: 88.93058161350844" data-width="1896" data-height="1066"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/87599756a6fd4893044d2fdbad1d9dea.png" alt="和式菜刀有很多种。这是切鳗鱼用的菜刀，这是厚尖刃菜刀，厚尖刃菜刀是用来切鱼和鸡之类有骨头的硬质食材的。然后这是柳刃刀，切生鱼片用的。锻造菜刀的方法也有两种：全钢和霞。全钢用的是纯钢锻造，而「霞」是用钢和铁复合锻造，钢的部分就成了坚硬而锐利的刀锋，钢与铁的交界处会形成美丽的「霞」。听说这就是它名称的由来。" /><figcaption>和式菜刀有很多种。这是切鳗鱼用的菜刀，这是厚尖刃菜刀，厚尖刃菜刀是用来切鱼和鸡之类有骨头的硬质食材的。然后这是柳刃刀，切生鱼片用的。锻造菜刀的方法也有两种：全钢和霞。全钢用的是纯钢锻造，而「霞」是用钢和铁复合锻造，钢的部分就成了坚硬而锐利的刀锋，钢与铁的交界处会形成美丽的「霞」。听说这就是它名称的由来。</figcaption></figure></p>
<blockquote><p>我才不管什么时代，我想编出「大渡海」。</p>
</blockquote>
<p><figure class="pswp-item" style="flex: 88.93058161350844" data-width="1896" data-height="1066"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/569a7bcf412cf918ea17b85e164676f8.png" alt="" /></figure></p>
<p>宅人的能量是可以超乎想象的，去骂骂蔡徐坤和吴亦凡你就能体会到了。但这是坏事吗？这是好事啊。如果可以因为偶像被诋毁而爆发中二宇宙，那也可以因为其它任何事爆发同样的宇宙：只要那触到了你的「宅点」。</p>
<p>宅人之所以无法为世人接受，背后的原因大致是信息上的割裂，我曾发过一条朋友圈：</p>
<blockquote><p>Underground 不是指见不得光的东西，而是除圈里人外没人能 get 到 high 点的东西。据此我认为吴亦凡和蔡徐坤都是 Underground 典范。</p>
</blockquote>
<p>与外界交流信息、互通有无是宅人永远的痛点。你所专注的东西是小众的，不为世人了解的，世人自然而然的无法理解你，无法与你感同身受。因此宅人们「活在自己的世界里」，变成了被世人猎奇的稀奇物种。反过来也是，宅人无法理解世人：你们为什么会对铁路不感兴趣呢？？？</p>
<p>老太太给了我们回答：</p>
<p><figure class="pswp-item" style="flex: 88.93058161350844" data-width="1896" data-height="1066"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/638059c6bd97851c4850b5a25bb5465e.png" alt="不懂别人的感受不是很正常吗？就是因为不懂才会对那个人感兴趣吧？就是因为不懂才需要交流吧？" /><figcaption>不懂别人的感受不是很正常吗？就是因为不懂才会对那个人感兴趣吧？就是因为不懂才需要交流吧？</figcaption></figure></p>
<p>「宅人」与「非宅人」之间的和解是电影中很重要的一条线。马缔与同事西冈之间从无法相互理解到能够合理分工利用自己的特长，就是一个很好的案例。另外，马缔逐渐向心上人吐露真情，也代表着这位宅人终于与外界接轨了：</p>
<p><figure class="pswp-item" style="flex: 88.93058161350844" data-width="1896" data-height="1066"><img src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/archives/assets/3612e568e9b83f36c4de26043ee95d1e.png" alt="「恋慕」：喜欢上一个人，无论是梦是醒，脑海中都萦绕着对方的身影，无心做任何事，烦恼苦闷的心理状态。一旦成功，则欣喜若狂，如直冲九霄" /><figcaption>「恋慕」：喜欢上一个人，无论是梦是醒，脑海中都萦绕着对方的身影，无心做任何事，烦恼苦闷的心理状态。一旦成功，则欣喜若狂，如直冲九霄</figcaption></figure></p>
<p>宅人很酷，我想说的就是这个意思。「宅」的精神与所谓工匠精神底层上有相似之处。「宅」的状态与雕刻家聚精会神完成作品时的状态根本就是相同的，这是一种排他的、高能的状态。</p>
<p>说到底，若要想真正地完成些精妙的东西，不中二是不行的。马缔对辞典纸张手感挑三拣四时，造纸工人除了一句「我们再研发！」之外别无多言，这才是我们需要追求的。</p>
<p>若你向别人说起某事物时得到评价说「这是除了你之外没人关心的东西」，直接大方的回应吧：「这确实是我关心的东西。而且，我认为它很棒。」</p>
<hr>
<p>另，「右」：面朝西方站立时，朝北的方向。当翻阅这本辞典时，偶数页的方向。数字 10 中，0 所在的方向。</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/291/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
    <article class="yue prism-post-item col-md-8 offset-md-2">
        <h1 class="prism-post-title"><a class="no-link" href="/archives/283/" target="_self">無消息 | 三無計劃</a></h1>
        <div class="prism-post-time">
            <a class="no-link" href="/archives/283/" target="_self">
                <time class="text-uppercase">
                    March 08 2019
                </time>
            </a>
        </div>
        <div class="prism-content"><p>我启动了「<span class="brand">三无计划</span>」的另一个项目：「<a href="https://t.me/triple_null">無消息</a>」。这是一个 Telegram 频道，如我在 <a href="https://twitter.com/AlanDecode/status/1103224813584150528">Twitter</a> 上所说，这个频道主要用来发一些链接、观察、思考与吐槽。</p>
<p>由于写博客主题的原因，过去一两个月我一直在思考<a href="https://blog.imalan.cn/archives/247/">《VOID：现在可以公开的情报》</a>这篇文章末尾提出的目标，即：</p>
<blockquote><p>为博主带来无障碍的写作环境、为读者带来无障碍的阅读环境</p>
</blockquote>
<p>我在 VOID 1.6.3 版中对主题首页做了大刀阔斧的改造，由以前的卡片式布局切换到了现在这样的简版布局，与最初的 VOID 几乎完全不同了。背后的原因部分就来自于上面的思考：因为我发现过分强调配图会打击博主的写作积极性，而这种积极性本来就已经濒临消失了。</p>
<p>Telegram 频道目前美誉甚多，它开放、自由，主要的内容形式为短消息，所以某些不能成文又想分享出去的东西放在这里可能是一个不错的做法。就让我尝试一下吧。</p>
<p>如果你感兴趣，请点击这里订阅：<a href="https://t.me/triple_null">無消息 | 三無計劃</a>。</p>
</div>
        
        <div class="prism-action-bar">
            <div class="comment-action action-item"><a class="no-link text-uppercase" href="/archives/283/#prism__comment" target="_self"><i class="fa fa-comment"></i>评论</a></div>
        </div>
        
    </article>
    
</section>

<div class="container">
    <section id="prism__page__pagination" class="prism-pagination" class="col-md-8 offset-md-2">
        <ul>
            
            <li class="next">
                <a class="no-link" href="/page/2/" target="_self"><i class="fa fa-chevron-left" aria-hidden="true"></i>更新</a>
            </li>
            
            
            <li class="prev">
                <a class="no-link" href="/page/4/" target="_self">更旧<i class="fa fa-chevron-right" aria-hidden="true"></i></a>
            </li>
            
        </ul>
    </section>
</div>


</main>

            <footer id="prism__footer">
                <section>
                    <div>
                        <nav class="social-links">
                            <ul><li><a class="no-link" title="Twitter" href="https://twitter.com/AlanDecode" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-twitter"></i></a></li><li><a class="no-link" title="GitHub" href="https://github.com/AlanDecode" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-github"></i></a></li><li><a class="no-link" title="Weibo" href="https://weibo.com/5245109677/" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-weibo"></i></a></li></ul>
                        </nav>
                    </div>

                    <section id="prism__external_links">
                        <ul>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://github.com/AlanDecode/Maverick" rel="noopener noreferrer nofollow">Maverick</a>：🏄‍ Go My Own Way.
                                <span>|</span>
                            </li>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://www.imalan.cn" rel="noopener noreferrer nofollow">三無計劃</a>：三是虚指。至于是哪三无，我唔知。
                                <span>|</span>
                            </li>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://wiki.imalan.cn" rel="noopener noreferrer nofollow">無知識</a>：熊猫小A的Wiki站点。隶属于「三无计划」。
                                <span>|</span>
                            </li>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://lab.imalan.cn" rel="noopener noreferrer nofollow">無項目</a>：熊猫小A的实验室。隶属于「三无计划」。
                                <span>|</span>
                            </li>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://t.me/triple_null" rel="noopener noreferrer nofollow">無消息</a>：熊猫小A的广播。隶属于「三无计划」。
                                <span>|</span>
                            </li>
                            
                        </ul>
                    </section>

                    <div class="copyright">
                        <p class="copyright-text">
                            <span class="brand">无文字 | 三无计划</span>
                            <span>Copyright © 2020 熊猫小A</span>
                        </p>
                        <p class="copyright-text powered-by">
                            | Powered by <a href="https://github.com/AlanDecode/Maverick" class="no-link" target="_blank" rel="noopener noreferrer nofollow">Maverick</a> | Theme <a href="https://github.com/Reedo0910/Maverick-Theme-Prism" target="_blank" class="no-link" rel="noopener noreferrer nofollow">Prism</a>
                        </p>
                    </div>
                    <div class="footer-addon">
                        
<a no-style href="http://beian.miit.gov.cn" target="_blank">京ICP备18000133号-1</a> | 
<a no-style href="https://www.upyun.com" target="_blank">又拍云</a>

                    </div>
                </section>
                <script>
                    var site_build_date = "2017-06-29T12:00+08:00"

                </script>
                <script src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/prism-a1bd79b1a4.js"></script>
            </footer>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/ExSearch/ExSearch-493cb9cd89.js"></script>

    <!--katex-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/katex.min.js"></script>
    <script>
        mathOpts = {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "\\[", right: "\\]", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false }
            ]
        };

    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e4f3a7c02ac2aabc41a1cfa95f61a026";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script>
if(window.location.hash){
    var checkExist = setInterval(function() {
       if ($(window.location.hash).length) {
          $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
          clearInterval(checkExist);
       }
    }, 100);
}
</script>
<script>
if(window.navigator && navigator.serviceWorker) {
  caches.keys().then(function(cacheNames) {
    cacheNames.forEach(function(cacheName) {
      caches.delete(cacheName);
    });
  }).then(function(){
    console.log('Cache cleaned.');
  });
  navigator.serviceWorker.getRegistrations()
  .then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  }).then(function(){
    console.log('Service Worker stopped.');
  });
}
</script>

</body>

</html>